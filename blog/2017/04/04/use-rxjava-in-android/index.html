<!-- START doctoc generated TOC please keep comment here to allow auto update -->


<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


<p><strong>Table of Contents</strong>  <em>generated with <a href="https://github.com/thlorenz/doctoc">DocToc</a></em></p>

<ul>
<li><a href="#flowableobservable">Flowable/Observable</a></li>
<li><a href="#consumerobserver">Consumer/Observer</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAflowable">创建一个Flowable</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAconsumer%E6%88%96%E8%80%85subscriber">创建一个Consumer或者Subscriber</a></li>
<li><a href="#%E5%BB%BA%E7%AB%8B%E8%81%94%E7%B3%BBsubscribe">建立联系<code>subscribe</code></a></li>
<li><a href="#%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2">线程切换</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8%E7%9A%84%E6%93%8D%E4%BD%9C%E7%AC%A6">常用的操作符</a></li>
</ul>


<!-- END doctoc generated TOC please keep comment here to allow auto update -->


<hr />

<p>layout: post
title: &ldquo;RxJava的初级使用&rdquo;
date: 2017-04-04 15:45:23 +0800
comments: true</p>

<h2>categories: rxjava</h2>

<blockquote><p>所有的东西都像流一样传播,无论是数据还是异常</p></blockquote>

<!--more-->


<h3>Flowable/Observable</h3>

<blockquote><p>被观察者，也就是被消费的事件源</p></blockquote>

<h3>Consumer/Observer</h3>

<blockquote><p>观察者,也就是消费者</p></blockquote>

<h3>创建一个Flowable</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//创建一个被观察者(也就是事件源)，当有人订阅他的时候，他就依次发射1,2,3
</span><span class='line'>Flowable&lt;Integer&gt; simpleFlowable = Flowable.just(1,2,3);
</span><span class='line'>
</span><span class='line'>//自己定义逻辑
</span><span class='line'>Flowable&lt;String&gt; standardFlowable = Flowable.create(new FlowableOnSubscribe&lt;String&gt;() {
</span><span class='line'>                @Override
</span><span class='line'>                public void subscribe(FlowableEmitter&lt;String&gt; e) throws Exception {
</span><span class='line'>                    //e这里可以理解成订阅者对象
</span><span class='line'>                    if(xxx){
</span><span class='line'>                        e.onNext("hello RxJava");//发射字符串
</span><span class='line'>                        e.onComplete();//标记该事件已结束
</span><span class='line'>                    }else{
</span><span class='line'>                        e.onError(new CustomException());//或者这里抛出某种异常,让下层知道
</span><span class='line'>                    }
</span><span class='line'>                }
</span><span class='line'>            }, BackpressureStrategy.LATEST);//这里是背压策略</span></code></pre></td></tr></table></div></figure>


<h3>创建一个Consumer或者Subscriber</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//标准版
</span><span class='line'>Subscriber&lt;Integer&gt; standardSubscriber = new Subscriber() {
</span><span class='line'>            @Override
</span><span class='line'>            public void onSubscribe(Subscription s) {
</span><span class='line'>                //刚发生订阅时的回调
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            @Override
</span><span class='line'>            public void onNext(Integer i) {
</span><span class='line'>                //接收到流
</span><span class='line'>                //如果我订阅了上面的justFlowable
</span><span class='line'>                //这里就依次打印1，2，3
</span><span class='line'>                Log.d("DEBUG","value is "+ i);
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            @Override
</span><span class='line'>            public void onError(Throwable t) {
</span><span class='line'>                //出现异常
</span><span class='line'>            }
</span><span class='line'>
</span><span class='line'>            @Override
</span><span class='line'>            public void onComplete() {
</span><span class='line'>                //该事件流结束
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>//简易版
</span><span class='line'>Consumer&lt;Integer&gt; simpleConsumer = new Consumer&lt;Integer&gt;() {
</span><span class='line'>            @Override
</span><span class='line'>            public void accept(@NonNull Integer integer) throws Exception {
</span><span class='line'>                //等同于上面的onNext(Integer i);
</span><span class='line'>            }
</span><span class='line'>        };</span></code></pre></td></tr></table></div></figure>


<h3>建立联系<code>subscribe</code></h3>

<p>用上面的栗子</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//标准版
</span><span class='line'>standardFlowable.subscribe(standardSubscriber);
</span><span class='line'>//简易版
</span><span class='line'>simpleFlowable.subscribe(simpleConsumer);
</span><span class='line'>
</span><span class='line'>需要注意的是如果这里只用simpleConsumer,在整个流传递的过程中如果有异常会直接抛出,所以还需要加一个异常处理的Consumer,
</span><span class='line'>subscribe()方法的第二个参数便是Consumer&lt;Throwable&gt;
</span><span class='line'>
</span><span class='line'>也就是
</span><span class='line'>simpleFlowable.subscribe(simpleConsumer,new Consumer&lt;Throwable&gt;() {
</span><span class='line'>            @Override
</span><span class='line'>            public void accept(@NonNull Throwable throwable) throws Exception {
</span><span class='line'>                    //异常处理
</span><span class='line'>                    //show error
</span><span class='line'>            }
</span><span class='line'>        });
</span></code></pre></td></tr></table></div></figure>


<h3>线程切换</h3>

<blockquote><p>耗时操作去子线程,更新ui回到主线程</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Flowable crazyFlowable = Flowable.create(xxx);
</span><span class='line'>crazyFlowable.subscribeOn(Schedulers.io())//订阅线程,也就是执行事件的线程
</span><span class='line'>             .observeOn(AndroidSchedulers.mainThread())//观察线程,将事件发送到的线程,也就是观察者执行的线程
</span><span class='line'>             .subscribe(new Consumer&lt;Integer&gt;() {
</span><span class='line'>                        @Override
</span><span class='line'>                        public void accept(@NonNull Integer integer) throws Exception {
</span><span class='line'>                            //更新UI
</span><span class='line'>                        }
</span><span class='line'>                    });
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>可以去看下<a href="http://tomstechnicalblog.blogspot.hk/2016/02/rxjava-understanding-observeon-and.html">这里面的几张图体会一下</a></p></blockquote>

<h3>常用的操作符</h3>

<ul>
<li><code>map</code>将一个对象转换成另一个对象
将上面栗子里面的int转换成String</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>standardFlowable.map(new Function&lt;Integer, String&gt;() {
</span><span class='line'>                @Override
</span><span class='line'>                public String apply(@NonNull Integer integer) throws Exception {
</span><span class='line'>                    return integer.toString();//自己定义的转换规则
</span><span class='line'>                }
</span><span class='line'>            }).subscribe(new Consumer&lt;String&gt;() {//订阅
</span><span class='line'>                @Override
</span><span class='line'>                public void accept(@NonNull String s) throws Exception {
</span><span class='line'>                        //这里接受的值从Integer变成了String
</span><span class='line'>                }
</span><span class='line'>            });
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>flatMap</code>将一个Flowable转换成另一个Flowable</li>
</ul>


<blockquote><p>使用场景,比如我要拉接口A,但是接口A的某个参数是接口B返回的,所以这里就需要先拉接口B</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Flowable&lt;String&gt; apiB = Flowable.just("params");//模拟接口B,他会返回一个参数
</span><span class='line'>apiB.flatMap(new Function&lt;String, Publisher&lt;Model&gt;&gt;() {
</span><span class='line'>                @Override
</span><span class='line'>                public Publisher&lt;Model&gt; apply(@NonNull String s) throws Exception {
</span><span class='line'>                //这里我拿到参数s,然后去请求接口A,这个接口返回一个model
</span><span class='line'>                Flowable&lt;Model&gt; apiA = Flowable.create(xxxxxx);
</span><span class='line'>                return apiA;//让流继续往下走
</span><span class='line'>                }
</span><span class='line'>            }).subscribe(new Consumer&lt;Model&gt;() {//订阅
</span><span class='line'>                @Override
</span><span class='line'>                public void accept(@NonNull Model model) throws Exception {
</span><span class='line'>                    //这里拿到model
</span><span class='line'>                }
</span><span class='line'>            });</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>compose</code>不要让链式断掉,代码复用</li>
</ul>


<blockquote><p><code>compose</code>接受一个FlowableTransformer<code>&lt;</code>Upstream, Downstream<code>&gt;</code>,Upstream是上流传过来的类型,
当前栗子是Integer类型, Downstream是经过处理后继续往下传的类型,当前栗子里面并没有改变,依旧是Integer</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class RxUtil{
</span><span class='line'>
</span><span class='line'>    //android中常用的线程切换的工具方法
</span><span class='line'>    public static &lt;T&gt; FlowableTransformer&lt;T, T&gt; scheduler() {
</span><span class='line'>        return new FlowableTransformer&lt;T, T&gt;() {
</span><span class='line'>            @Override
</span><span class='line'>            public Publisher&lt;T&gt; apply(Flowable&lt;T&gt; upstream) {
</span><span class='line'>                return upstream.subscribeOn(Schedulers.io())
</span><span class='line'>                        .observeOn(AndroidSchedulers.mainThread());
</span><span class='line'>            }
</span><span class='line'>        };
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>使用</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Flowable.just(1)
</span><span class='line'>        .compose(RxUtil.&lt;Integer&gt;scheduler())
</span><span class='line'>        .subscribe(new Consumer&lt;Integer&gt;(){
</span><span class='line'>            @overide
</span><span class='line'>            public void accept(@NonNull Integer i) throw Exception{
</span><span class='line'>                //do something
</span><span class='line'>            }
</span><span class='line'>        });
</span><span class='line'>等价于
</span><span class='line'>Flowable.just(1)
</span><span class='line'>        .subscribeOn(Schedulers.io())
</span><span class='line'>        .observeOn(AndroidSchedulers.mainThread())
</span><span class='line'>        .subscribe(new Consumer&lt;Integer&gt;(){
</span><span class='line'>            @overide
</span><span class='line'>            public void accept(@NonNull Integer i) throw Exception{
</span><span class='line'>                //do something
</span><span class='line'>            }
</span><span class='line'>        });</span></code></pre></td></tr></table></div></figure>


<ul>
<li>doOnNext</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Flowable.just("sth")//假设这是一个网络请求返回的Flowable
</span><span class='line'>                .doOnNext(new Consumer&lt;String&gt;() {
</span><span class='line'>                    @Override
</span><span class='line'>                    public void accept(@NonNull String s) throws Exception {
</span><span class='line'>                        //在这里我们可以把数据缓存下来～
</span><span class='line'>                    }
</span><span class='line'>                });</span></code></pre></td></tr></table></div></figure>


<ul>
<li>onErrorResumeNext

<blockquote><p>当出现错误时,我们可以做中途截获</p></blockquote></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//假设我们的获取数据的策略是先从本地取,如果没有的话,就走网络
</span><span class='line'>Flowable&lt;String&gt; cacheFlowable = Flowable.create(new FlowableOnSubscribe&lt;String&gt;() {
</span><span class='line'>                @Override
</span><span class='line'>                public void subscribe(FlowableEmitter&lt;String&gt; e) throws Exception {
</span><span class='line'>                     if(没有缓存){
</span><span class='line'>                        e.onError(new NoCacheException());//或者这里抛出某种异常,让下层知道
</span><span class='line'>                     }
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        }, BackpressureStrategy.LATEST)
</span><span class='line'>        .onErrorResumeNext(new Function&lt;Throwable, Publisher&lt;? extends Integer&gt;&gt;() {
</span><span class='line'>            @Override
</span><span class='line'>            public Publisher&lt;? extends Integer&gt; apply(@NonNull Throwable throwable) throws Exception {
</span><span class='line'>                //在这里犀利捕获
</span><span class='line'>                if(throwable instanceof NoCacheException){
</span><span class='line'>                    return 一个网络的Flowable
</span><span class='line'>                }
</span><span class='line'>            }
</span><span class='line'>        });</span></code></pre></td></tr></table></div></figure>

